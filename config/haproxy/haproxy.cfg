# HAProxy Configuration for OTP Service
# Production Load Balancing and SSL Termination

global
    # Process management
    daemon
    chroot /var/lib/haproxy
    stats socket /var/lib/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy

    # Security
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 8192

defaults
    mode http
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    timeout http-request 15s
    timeout http-keep-alive 15s
    
    # Health checks
    option httpchk GET /health
    option httplog
    option dontlognull
    option redispatch
    retries 3
    
    # Headers
    option forwardfor
    option http-server-close
    
    # Error pages
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# =============================================================================
# Frontend (SSL Termination)
# =============================================================================
frontend otp_frontend
    bind *:80
    bind *:443 ssl crt /certs/server.pem alpn h2,http/1.1
    
    # Redirect HTTP to HTTPS
    redirect scheme https if !{ ssl_fc }
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # Rate limiting (basic)
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 100 }
    
    # Health check endpoint
    acl is_health path_beg /health
    acl is_metrics path_beg /metrics
    
    # API routing
    use_backend otp_backend if !is_health !is_metrics
    use_backend stats_backend if is_metrics

# =============================================================================
# Backend (OTP Service)
# =============================================================================
backend otp_backend
    balance roundrobin
    option httpchk GET /health
    
    # Health check configuration
    default-server inter 10s downinter 5s rise 3 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
    
    # Backend servers (will be auto-discovered in Docker Swarm)
    server-template otp- 3 otp-service:8080 check resolvers docker init-addr none

# =============================================================================
# Stats Backend
# =============================================================================
backend stats_backend
    balance roundrobin
    server-template otp- 3 otp-service:9090 check resolvers docker init-addr none

# =============================================================================
# Stats Interface
# =============================================================================
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats admin if TRUE
    
    # Basic auth for stats (change password)
    stats auth admin:secure_password_here
    
    # Stats page styling
    stats realm HAProxy\ Statistics
    stats show-node